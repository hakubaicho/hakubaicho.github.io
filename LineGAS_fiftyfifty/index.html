<!DOCTYPE html>
<html lang="ja">

<head>
  <!-- 
    スライドショー
    -ゆっくりズームアウトさせながら全画面で見せる-
    https://coco-factory.jp/ugokuweb/move01/6-1-3/ 
  -->
  <meta charset="utf-8">
  <title>スライドショー</title>
  <!-- <meta name="viewport" content="width=device-width,initial-scale=1.0"> -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="css/styles.css" />
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <!--自作のJS-->
  <script src="js/images.js"></script>
  <script src="js/terops.js"></script>

</head>

<body>

  <!-- サイネージコンテナ -->
  <div class="signage-container">
    <!-- 画像スライドショーコンテナ -->
    <div class="signage-slideshow-area">
      <img src="img/halloween_card00.jpg" id="pics">
    </div>
    <!-- テロップコンテナ -->
    <div class="signage-terop-area">
      <div class="terop-container">
        <div class="terop-container-top">
          <p id="terops">
            実業家の堀江貴文氏（48）らが福岡県北九州市に設立し、来季から独立リーグ「ヤマエ久野九州アジアリーグ」へ参入する新球団「福岡北九州フェニックス」は17日、ロッテ、ツインズ、阪神で活躍した西岡剛氏（37）が選手兼任監督に、ジョニー・セリス氏（34）がヘッドコーチに就任することを発表した。
            【写真】ロッテ時代、コーンロウの髪形の 西岡剛氏
            西岡氏は球団を通じて「この度、福岡北九州フェニックスの監督に就任することになりました。九州に身を置いて野球に携われることをうれしく思います。野球というスポーツを通じてたくさんの方と出会い野球の楽しさをお届けできるように頑張ります。よろしくお願い申し上げます」とコメントした。将来的には世界進出も視野に入れる新球団の初代監督として、選手兼任で九州の地を盛り上げる。
          </p>
        </div>
        <div class="terop-container-bottom">
          <p id="status-of-api">未取得</p>
        </div>
      </div>
    </div>
    <!-- NewsTicker部分 -->
    <div id="news_ticker">
      <ul id="news_ticker_list">
        <li class="news_ticker_list_item lastTerop">
          <p>ダミーテキスト</p>
        </li>
    </div>
  </div>

  <!-- <button id="playButton" onclick="playSlidedeshow();">PLAY</button> -->

  <script>
    // APIのURL
    const endpoint = "https://script.google.com/macros/s/AKfycbyarYp4dlnCKKilnOJ1wLwCE6XuftXD9M89fvMxAdQ3QdFqoz7P5G8HiZJr1Yfb4eJFeA/exec";
    let news_terops = [];
    function inputToGoogleAPI(isStart) {
      document.getElementById('status-of-api').textContent = "データ取得中";
      $.ajax({
        type: 'GET',
        url: endpoint,
        dataType: 'jsonp',
        // dataType: 'json',
        data: {
          text: 'Hi,There!'
          // text: inputvalue
        }
      })
        .done(function (out) {
          const terops = out.terop;
          const images = out.image;

          news_terops = [];
          for (let i = 0; i < terops.length; i++) {
            news_terops.push(terops[i].terop);
          }
          reloadPicture(images);
          reloadTerop(terops);
          // データ取得の結果
          let todayDate = new Date();
          let strDate = "";
          strDate += `${todayDate.getFullYear()}/${todayDate.getMonth() + 1}/${todayDate.getDay()}`;
          strDate += " ";
          strDate += `${todayDate.getHours()}:${todayDate.getMinutes()}:${todayDate.getMinutes()}`;
          document.getElementById('status-of-api').textContent = `データ取得完了:${strDate}`;
        })
        .fail(function (err) {
          document.getElementById('status-of-api').textContent = `エラーが起きました:${err}`;
          // alert("エラーが起きました");
        })
        .always(function () {
          console.log("Ajax処理終了");
        });

      if (isStart) {
        playSlidedeshow();
        playTerop();
      };
    }

    window.onload = () => {
      inputToGoogleAPI(true);
      terop_init();
    };
    const countUp = () => {
      inputToGoogleAPI(false);
    }
    setInterval(countUp, 60000);
    set_terop_speed(10);
  </script>
  <script>
    /**
     * 速度
     */
    let speed_const = 5;

    let index = 0;
    /**
     * ***************************************************
     * テロップ速度の変更
     * ***************************************************
     */
    function set_terop_speed(speed) {
      speed_const = speed;
    }
    /**
     * ***************************************************
     * テロップの再セット
     * ***************************************************
     */
    function reload_terop() {

      const container = document.getElementById("news_ticker_list");
      // 全要素削除
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // 要素の追加
      for (let i = 0; i < news_terops.length; i++) {
        const li = document.createElement('li');
        li.classList.add("news_ticker_list_item");
        var p = document.createElement('p');
        p.innerText = news_terops[i];
        li.append(p);
        container.append(li)
      }
      // 終端を入れる
      const li = document.createElement('li');
      li.classList.add("news_ticker_list_item");
      li.classList.add("lastTerop");

      var p = document.createElement('p');
      p.innerText = "最後のテロップ　リロードの合図";
      li.append(p);
      li.append(p);
      container.append(li)

      // <li class="news_ticker_list_item">
      //   <p>ダミーテキスト</p>
      // </li>
    }

    /**
     * ***************************************************
     * NewsTickerの動き方
     * ***************************************************
     */
    function terop_init() {
      $(function () {

        function tickerTxt() {
          if ($("#news_ticker").length) {
            var a = $("#news_ticker_list");
            var r = $(".news_ticker_list_item:first-child", a);
            //--------------------------------
            // 最後のテロップなら
            //--------------------------------
            if (r.hasClass('lastTerop')) {
              reload_terop();
              index++;
              if (2 < index) {
                index = 0;
              }
            }
            //--------------------------------
            // 右端に寄せた状態から始めたい
            //--------------------------------
            var container = $("#news_ticker");
            var windowWidth = container.width();
            //--------------------------------
            var a = $("#news_ticker_list");
            var r = $(".news_ticker_list_item:first-child", a);
            var width = r.width();
            //--------------------------------
            // 速度の設定
            //--------------------------------
            var speed = (width + windowWidth) * speed_const;
            console.log(`幅:${windowWidth} / speed:${speed}`);
            r.addClass("is-active");
            //--------------------------------
            // テロップのアニメーション効果。
            //--------------------------------
            $(".is-active", a).css({ left: windowWidth }).delay(1000).animate({ left: -width - 20 }, speed, "linear", function () {
              $(".is-active", a).next().addClass("is-active").end().removeClass("is-active").appendTo(a);
              tickerTxt();
            });
          }
        }
        tickerTxt();
      });
    }
  </script>
</body>

</html>