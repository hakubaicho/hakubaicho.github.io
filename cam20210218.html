<!Doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache">
    <title>*カメラの解像度確認*</title>
  </head>
  <body>
    <!-- このページの目的 -->
    <div> 
      <p>Chromeでの解像度確認</p>
      <p><a href="chrome://media-internals/">chrome://media-internals/</a></p>
      chrome://media-internals/
      <div>
        <button type="button" onclick="videoSize(480, 640)">H:480 * W:640</button>
        <button type="button" onclick="videoSize(640, 480)">H:640 * W:480</button>
        <button type="button" onclick="videoSize(1920, 1080)">H:1920 * W:1080</button>
        <button type="button" onclick="videoSize(1080, 1920)">H:1080 * W:1920</button>
      </div>
      <div>
        <select id="camera_list" size="1" style="width:160pt;">
          <option>(video)</option>
        </select>
      </div>
    </div>
    <!-- カメラ映像とカメラの解像度を表示する -->
    <div>
      <p id="resolution-height"></p>
      <p id="resolution-width"></p>
      <div>
        <button type="button" onclick="videocapture()">撮影</button>
      </div>
      <video id="camera" autoplay="1" ></video>
    </div> 
    
    <div>
      <button type="button" onclick="videoStart()">開始</button>
      <button type="button" onclick="videoStop()">停止</button>
      <button type="button" onclick="cameraPositionChange()">反転</button>
    </div>
    <!-- 切り替えボタン -->
    <button type="button" id="btn-toggle" onclick="">
      <img src="img/retweet-solid.svg" width="64" height="64">
    </button>
    <div>
      <canvas id="canvas-capture"></canvas>
    </div>

    <!-- メディアデバイスの列挙 -->
    <div id="camera-devices">
      <p>mediaDevicesを列挙します。</p>
      <button type="button" onclick="getCameraDevices()">取得</button>
      <div id="list-camera-devices">
      </div>
    </div>















    <script type="text/javascript">
      'use strict';
      //------------------------------------------
      // 定数領域にidで指定した要素を代入する
      //------------------------------------------
      const $divListCameraDevices = document.getElementById("list-camera-devices");   // カメラデバイス列挙エリア
      const $label_h =document.getElementById("resolution-height");
      const $label_w =document.getElementById("resolution-width");
      const $canvasCapture =document.getElementById("canvas-capture");
      const video = document.querySelector("#camera");
      const cameraList = document.getElementById("camera_list");

      //------------------------------------------
      // 変数領域
      //------------------------------------------
      let useFront = true;                        // フロントカメラ:true, バックカメラ:false
      //------------------------------------------
      // グローバル変数
      //------------------------------------------
      // カメラのデフォルト設定
      const CONSTRAINTS = {
        audio: false,
        video: {
          
          //--------------------------
          // PCでやるときの設定
          //--------------------------
          width: 640,
          height: 480,
          //--------------------------
          // スマホでやるときの設定
          //--------------------------
          // min    :最小値
          // max    :最大値
          // ideal  :理想的な値
          // width: { min: 320, ideal: 1920, max: 1920 },
          // height: { min: 180, ideal: 1080, max:1080},
          aspectRatio: 1.777777778,
          frameRate: { max: 30 },
        
          facingMode: null,  // どのカメラを利用するか
          // facingModeには最終的に以下のいずれかの値を入れる
          //   facingMode: "user"                    // フロントカメラを利用する
          //   facingMode: { exact: "environment" }  // リアカメラを利用する
          deviceId: null
        }
      };
      // 現在のStream
      var curSTREAM = null;

      //---------------------------------------------
      // [event] ページ読み込み完了
      //---------------------------------------------
      window.onload = () => {
        // カメラと同期開始
        syncCamera(video, useFront);
        useFront = !useFront;         // boolean値を反転

        getCameraDevices();
      };

      function videoSize(height, width) {
        CONSTRAINTS.video.height = height;
        CONSTRAINTS.video.width = width;
        syncCamera(video);
      }
      //
      // カメラを<video>と同期
      //
      // @param {object} video
      // @param {boolean} [is_front=true]
      //
      function syncCamera(video, is_front=true){
        // 前後カメラの設定
        CONSTRAINTS.video.facingMode = (is_front)?  "user":{ exact: "environment" };
        
        // すでにカメラと接続していたら停止
        if( curSTREAM !== null ){
          curSTREAM.getVideoTracks().forEach( (camera) => {
            camera.stop();
          });
        }

        // カメラと接続する
        navigator.mediaDevices.getUserMedia(CONSTRAINTS)
          .then( (stream) => {
            curSTREAM = stream;   // 前後の切り替え用に保持

            // <video>とStremaを接続
            video.srcObject = stream;
            video.onloadedmetadata = (e) => {
              video.play();
              // 解像度を画面表示
              $label_h.innerText =`H:${video.videoHeight}`;
              $label_w.innerText =`W:${video.videoWidth}`;
            };
          })
          .catch( (err) => {
            console.log(`${err.name}: ${err.message}`);
            alert(
              "カメラとの接続時にエラーが発生しました" + "\n"
              + err.name + "\n"
              + err.message
              );
          });
      }
      function stopCamera()
      {
        // すでにカメラと接続していたら停止
        if( curSTREAM !== null ){
          curSTREAM.getVideoTracks().forEach( (camera) => {
            camera.stop();
          });
        }
      }
      // カメラの反転
      function cameraPositionChange()
      {
        syncCamera(video, useFront);
        useFront = !useFront;      // boolean値を反転
      };
    
      // コピー処理
      function videocapture()
      {
        $canvasCapture.width  = video.videoWidth;
        $canvasCapture.height = video.videoHeight;
        $canvasCapture.getContext('2d').drawImage(video, 0, 0);  // canvasに『「静止画取得」ボタン』押下時点の画像を描画
      }
      //--------------------------------------------
      // メディアデバイスを取得する
      // https://developer.mozilla.org/ja/docs/Web/API/MediaDevices/enumerateDevices
      // https://qiita.com/massie_g/items/b9863e4366cfed339528
      // https://mganeko.github.io/webrtcexpjp/tool/devicelist.html
      //--------------------------------------------
      function getCameraDevices() 
      {
        $divListCameraDevices.innerHTML="";
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
          console.log("enumerateDevices() not supported.");
          return;
        }
        // カメラリストのクリア
        while(cameraList.lastChild) {
          cameraList.removeChild(cameraList.lastChild);
        }
        
        // List cameras and microphones.
        // kindは   "videoinput"
        //          "audioinput"
        //          "audiooutput"
        navigator.mediaDevices.enumerateDevices()
        .then(function(devices) {
          // デバイス情報 MediaDeviceInfo の内容
          // deviceId       ：（デバイスID)
          // kind           ：（種類：　audioinput, videoinput, audiooutput ）
          //                  ※ audiooutput は Chromeのみ
          // label （名称） ：取得できる場合と、できない場合がある
          // groupId        ：同一ハード機器内のデバイスでは同じになる仕様（けど、まだ？）
          // 成功時
          devices.forEach(function(device, index) {
            console.log(device.kind + ": " + device.label +
                        " id = " + device.deviceId);
            if(device.kind === 'videoinput')
            {
              // セレクトボックスの追加
              var id = device.deviceId;
              var label = device.label || 'camera'; // label is available for https 
              const option = document.createElement('option');
              option.setAttribute('value', id);
              option.innerHTML = label + '(' + id + ')';
              cameraList.appendChild(option);
            }
            // 指定要素にデバイス情報を要素で追加
            const p = document.createElement('p');
            p.innerHTML = `*** [${index}] ***` 
                          + "<br>"
                          + `Kind: ${device.kind}` 
                          + "<br>" 
                          + `Label: ${device.label}`
                          + "<br>" 
                          + `Id: ${device.deviceId}`
            $divListCameraDevices.appendChild(p);
          });
        })
        // エラー発生時
        .catch(function(err) {
          console.log(err.name + ": " + err.message);
        });
      }
    </script>
  </body>
</html>